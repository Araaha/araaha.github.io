<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Extreme ZSH Performance
        
    </title><meta content="Extreme ZSH Performance" property=og:title><link href=/icon/favicon.ico rel=icon type=image/png><link href=https://araaha.me/fonts.css rel=stylesheet><link href=https://araaha.me/atom.xml rel=alternate title=Araaha type=application/atom+xml><link href=https://araaha.me/theme/dark.css rel=stylesheet><link href=https://araaha.me/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://araaha.me>Araaha</a><div class=socials><a class=social href=https://github.com/araaha/ rel=me target=_blank> <img alt=github src=/social_icons/github.svg> </a><a class=social href=mailto:ara.ahady@gmail.com rel=me target=_blank> <img alt=email src=/social_icons/email.svg> </a><a class=social href=https://linkedin.com/in/araaha rel=me target=_blank> <img alt=linkedin src=/social_icons/linkedin.svg> </a><a class=social href=/atom.xml rel=me target=_blank> <img alt=rss src=/social_icons/rss.svg> </a></div></div><nav><a href=/blog style=margin-left:.7em><span>/</span>blog<span>/</span></a><a href=/projects style=margin-left:.7em><span>/</span>projects<span>/</span></a><a href=/about style=margin-left:.7em><span>/</span>about<span>/</span></a></nav></header><main><article><div class=title><div class=page-header>Extreme ZSH Performance<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-02-07</time></div></div><section class=body><p>This blog post is for those looking to improve their ZSH startup time. With a clean <code>.zshrc</code>, ZSH is quite fast. But once you start adding various things to it, it can slow down dramatically.<p>TLDR: Organize your <code>.zshrc</code> effectively and use <a href=https://github.com/romkatv/zsh-defer>zsh-defer</a>.<h1 id=performance-analysis>Performance Analysis</h1><p>While you could use everything from <code>zprof</code> to <code>hyperfine</code> and <code>time</code>, the most comprehensive way is with <a href=https://github.com/romkatv/zsh-bench>zsh-bench</a>. Just run<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#9dc365>git</span><span style=color:#83a598> clone https://github.com/romkatv/zsh-bench </span><span style=color:#d3869b>~</span><span style=color:#83a598>/zsh-bench </span><span style=color:#fe8019>&& cd</span><span style=color:#83a598> zsh-bench
</span></code></pre><p>in your terminal. Running the <code>zsh-bench</code> script outputs this:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#fe8019>=</span><span style=color:#9dc365>=</span><span style=color:#fe8019>></span><span style=color:#83a598> benchmarking </span><span style=color:#9dc365>login</span><span style=color:#83a598> shell of user araaha ...
</span><span style=color:#83a598>creates_tty</span><span style=color:#fe8019>=</span><span style=color:#9dc365>1
</span><span style=color:#83a598>has_compsys</span><span style=color:#fe8019>=</span><span style=color:#9dc365>1
</span><span style=color:#83a598>has_syntax_highlighting</span><span style=color:#fe8019>=</span><span style=color:#9dc365>1
</span><span style=color:#83a598>has_autosuggestions</span><span style=color:#fe8019>=</span><span style=color:#9dc365>1
</span><span style=color:#83a598>has_git_prompt</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>first_prompt_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>237.871
</span><span style=color:#83a598>first_command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>263.405
</span><span style=color:#83a598>command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>40.244
</span><span style=color:#83a598>input_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>11.732
</span><span style=color:#83a598>exit_time_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>90.718
</span></code></pre><p>on an AMD laptop (Ryzen 5 5500U).<p>The lines we want to focus on are the latter four:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#83a598>first_prompt_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>237.871
</span><span style=color:#83a598>first_command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>263.405
</span><span style=color:#83a598>command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>40.244
</span><span style=color:#83a598>input_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>11.732
</span></code></pre><p>The line <code>first_prompt_lag_ms</code> measures the time until the prompt appears. Similarly, <code>first_command_lag_ms</code> measures the time until you can start typing a command. <code>command_lag_ms</code> measures the time between the execution of a command and the first moment a prompt appears thereafter. Lastly, <code>input_lag_ms</code> measures the time between keystrokes. As reference, using a totally clean <code>.zshrc</code>, the following is printed out:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#fe8019>=</span><span style=color:#9dc365>=</span><span style=color:#fe8019>></span><span style=color:#83a598> benchmarking </span><span style=color:#9dc365>login</span><span style=color:#83a598> shell of user araaha ...
</span><span style=color:#83a598>creates_tty</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_compsys</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_syntax_highlighting</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_autosuggestions</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_git_prompt</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>first_prompt_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>12.648
</span><span style=color:#83a598>first_command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>13.152
</span><span style=color:#83a598>command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0.537
</span><span style=color:#83a598>input_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0.357
</span><span style=color:#83a598>exit_time_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>10.877
</span></code></pre><h1 id=organizing-zsh>Organizing ZSH</h1><p>Originally, I had a <code>.zshrc</code> with hundreds of lines. I managed to reduce it to just 7. You can use <code>$ZDOTDIR</code> to place your zsh config in a dedicated folder. In any case, I have mine exported as<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#fb4934>export </span><span style=color:#83a598>ZDOTDIR</span><span style=color:#fe8019>=</span><span style=color:#9dc365>/home/araaha/.config/zsh
</span></code></pre><p>in <code>/etc/zsh/zshenv</code>. That way, <code>$HOME</code> is kept uncluttered. The layout is as follows:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#9dc365>zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>├─</span><span style=color:#83a598> modules
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ tty.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ bindkeys.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ fzf.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ aliases.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ prompt.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ zoxide.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ exports.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ compinit.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ zstyle.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ options.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  ├─ pre-defer.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>│</span><span style=color:#83a598>  └─ history.zsh
</span><span style=color:#83a598> </span><span style=color:#9dc365>└─</span><span style=color:#83a598> plugins
</span><span style=color:#83a598>    </span><span style=color:#9dc365>├─</span><span style=color:#83a598> zsh-defer
</span><span style=color:#83a598>    </span><span style=color:#9dc365>├─</span><span style=color:#83a598> vi-motions
</span><span style=color:#83a598>    </span><span style=color:#9dc365>├─</span><span style=color:#83a598> fast-syntax-highlighting
</span><span style=color:#83a598>    </span><span style=color:#9dc365>├─</span><span style=color:#83a598> zsh-autosuggestions
</span><span style=color:#83a598>    </span><span style=color:#9dc365>└─</span><span style=color:#83a598> zsh-completion-generator
</span></code></pre><p>Every plugin I have is placed in <code>plugins</code> and everything else in <code>modules</code>. For example, <code>exports.zsh</code> includes exports I have. Similarly, <code>aliases.zsh</code> includes aliases I have.<h1 id=zsh-defer>Zsh-defer</h1><p>Now, rewriting your <code>.zshrc</code> is straightforward. Personally, the first three lines in my <code>.zshrc</code> are:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#fb4934>export </span><span style=color:#83a598>ZSH</span><span style=color:#fe8019>="</span><span style=color:#458588>$</span><span style=color:#83a598>HOME</span><span style=color:#9dc365>/.config/zsh</span><span style=color:#fe8019>"
</span><span style=color:#fb4934>export </span><span style=color:#83a598>PLUG</span><span style=color:#fe8019>="</span><span style=color:#458588>$</span><span style=color:#83a598>ZSH</span><span style=color:#9dc365>/plugins</span><span style=color:#fe8019>"
</span><span style=color:#fb4934>export </span><span style=color:#83a598>MOD</span><span style=color:#fe8019>="</span><span style=color:#458588>$</span><span style=color:#83a598>ZSH</span><span style=color:#9dc365>/modules</span><span style=color:#fe8019>"
</span></code></pre><p>We can start sourcing our modules and plugins and use <a href=https://github.com/romkatv/zsh-defer>zsh-defer</a> as much as possible. <a href=https://github.com/romkatv/zsh-defer>zsh-defer</a> allows us to defer ZSH commands. It has to come before sourcing anything you want to defer. In some cases, you'll end up breaking things by deferring. In my case, I can't defer the <a href=https://github.com/jeffreytse/zsh-vi-mode>zsh-vi-mode</a> plugin. I also don't defer my prompt, zsh opts and my history opts. In any case, the latter three don't siginificantly affect startup time.<p>By the end, I ended up with<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#fe8019>source "</span><span style=color:#458588>$</span><span style=color:#83a598>ZDOTDIR</span><span style=color:#9dc365>/modules/pre-defer.zsh</span><span style=color:#fe8019>"
</span><span style=color:#83a598>
</span><span style=color:#83a598>defer</span><span style=color:#fe8019>=("</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/prompt.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/exports.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/aliases.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/bindkeys.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/compinit.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/zstyle.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/zoxide.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>MOD</span><span style=color:#9dc365>/fzf.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>PLUG</span><span style=color:#9dc365>/vi-motions/motions.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>PLUG</span><span style=color:#9dc365>/zsh-autosuggestions/zsh-autosuggestions.zsh</span><span style=color:#fe8019>" "</span><span style=color:#458588>$</span><span style=color:#83a598>PLUG</span><span style=color:#9dc365>/fast-syntax-highlighting/fast-syntax-highlighting.zsh</span><span style=color:#fe8019>")
</span><span style=color:#83a598>
</span><span style=color:#fb4934>for</span><span style=color:#83a598> file </span><span style=color:#fb4934>in </span><span style=color:#fe8019>"</span><span style=color:#458588>$</span><span style=color:#fe8019>{</span><span style=color:#83a598>defer</span><span style=color:#fe8019>[</span><span style=color:#d3869b>@</span><span style=color:#fe8019>]}"; </span><span style=color:#fb4934>do
</span><span style=color:#83a598>    </span><span style=color:#9dc365>zsh-defer</span><span style=color:#83a598> source </span><span style=color:#fe8019>"</span><span style=color:#458588>$</span><span style=color:#83a598>file</span><span style=color:#fe8019>"
</span><span style=color:#fb4934>done
</span></code></pre><p>which led to this result from <a href=https://github.com/romkatv/zsh-bench>zsh-bench</a>:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#fe8019>=</span><span style=color:#9dc365>=</span><span style=color:#fe8019>></span><span style=color:#83a598> benchmarking </span><span style=color:#9dc365>login</span><span style=color:#83a598> shell of user araaha ...
</span><span style=color:#83a598>creates_tty</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_compsys</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_syntax_highlighting</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_autosuggestions</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>has_git_prompt</span><span style=color:#fe8019>=</span><span style=color:#9dc365>0
</span><span style=color:#83a598>first_prompt_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>84.171
</span><span style=color:#83a598>first_command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>92.650
</span><span style=color:#83a598>command_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>39.395
</span><span style=color:#83a598>input_lag_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>11.381
</span><span style=color:#83a598>exit_time_ms</span><span style=color:#fe8019>=</span><span style=color:#9dc365>13.126
</span></code></pre><p>The plugins that affect performance the most are <a href=https://github.com/zsh-users/zsh-autosuggestions>zsh-autosuggestions</a> and <a href=https://github.com/jeffreytse/zsh-vi-mode>zsh-vi-mode</a>. Without them, <code>command_lag_ms</code> is almost zero and <code>first_prompt_lag_ms</code>, <code>first_command_lag_ms</code> are respectively ~10-20ms.<h1 id=additional-optimizations>Additional Optimizations</h1><h2 id=compinit>Compinit</h2><p><code>compinit</code> siginificantly affects startup time. We can cache it once a day to speed things up:<pre class=language-sh data-lang=sh style=color:#ebdbb280;background-color:#242424><code class=language-sh data-lang=sh><span style=color:#9dc365>autoload</span><span style=color:#fe8019> -</span><span style=color:#83a598>Uz compinit
</span><span style=color:#fb4934>if </span><span style=color:#fe8019>[ </span><span style=color:#458588>$</span><span style=color:#fe8019>(</span><span style=color:#9dc365>date</span><span style=color:#83a598> +</span><span style=color:#fe8019>'</span><span style=color:#9dc365>%j</span><span style=color:#fe8019>') != </span><span style=color:#458588>$</span><span style=color:#fe8019>(</span><span style=color:#9dc365>date</span><span style=color:#fe8019> -</span><span style=color:#83a598>r </span><span style=color:#458588>$</span><span style=color:#83a598>ZSH/.zcompdump +</span><span style=color:#fe8019>'</span><span style=color:#9dc365>%j</span><span style=color:#fe8019>') ]; </span><span style=color:#fb4934>then
</span><span style=color:#83a598>    </span><span style=color:#9dc365>compinit
</span><span style=color:#fb4934>else
</span><span style=color:#83a598>    </span><span style=color:#9dc365>compinit</span><span style=color:#fe8019> -</span><span style=color:#83a598>C
</span><span style=color:#fb4934>fi
</span></code></pre><h2 id=zcompile>Zcompile</h2><p>Using <code>zcompile</code> on your plugins can have an impact. E.g., using <code>zcompile</code> on <a href=https://github.com/jeffreytse/zsh-vi-mode>zsh-vi-mode</a> reduces my startup time by ~10ms.<h2 id=git-prompt>Git Prompt</h2><p>Using an async git prompt will likely improve performance.<h2 id=oh-my-zsh>Oh-My-ZSH</h2><p>OMZ has dozens of plugins, most of which you likely won't use. It's better to create your own config and only include plugins you regularly use.</section></article></main></div>